//go:build integration

package gateway_test

import (
	"encoding/json"
	"fmt"
	"io/ioutil"
	pb "mlslisting/internal/generated/realogy.com/api/mls/v1"
	"net/http"
	"strings"
	"testing"

	"github.com/golang/protobuf/jsonpb"
	"github.com/nsf/jsondiff"
	"github.com/stretchr/testify/assert"
)

const (
	port             = 9081
	listing100018    = string(`{"mlsListings":[{"property":{"propertyType":"LAND","propertySubType":"","financial":null,"listing":{"listingId":"100018","sourceSystemKey":"KY_WKRMLS","sourceSystemName":"","standardStatus":"ACTIVE","buildingPermits":"","documentsAvailable":"","disclosures":"","contract":{"currentFinancing":"","specialListingConditions":{"isForeclosure":false,"isShortSale":false,"isProbateSale":false}},"price":{"listPrice":15000,"listPriceHigh":0,"isPriceReduced":true,"priceChangeTimestamp":null,"originalListPrice":19000,"closePrice":0,"petRent":0,"monthsRentUpfront":0,"currency":"USD"},"agentOffice":{"listAgent":{"listAgentFullname":"JOEY RICKS","listAgentMlsId":"21","listAgentOfficePhone":"","listAgentOfficePhoneType":"","listAgentStateLicense":"","listAgentStateLicenseState":"","listAgentEmail":"","listAgentActive":false,"listAgentAddress":"","listAgentCity":"","listAgentStateOrProvince":"","listAgentPostalCode":"","listAgentType":"","listAgentOriginalEntryTimestamp":null,"listAgentModificationTimestamp":null},"listOffice":{"listOfficeName":"COLDWELL BANKER SERVICE 1ST REALTY","listOfficePhone":"800-522-4699","listOfficeMlsId":"23","listOfficeAddress":"","listOfficeCity":"","listOfficeStateOrProvince":"","listOfficePostalCode":"","listOfficeEmail":"","listOfficeFax":"","listOfficeOriginalEntryTimestamp":null,"listOfficeModificationTimestamp":null},"coListAgent":null,"coListOffice":null,"buyerAgent":null,"buyerOffice":null,"coBuyerAgent":null,"coBuyerOffice":null,"idxContactInfo":""},"compensation":{"listAgencyCompensation":null,"buyerAgencyCompensation":{"percentage":0,"fee":0,"commission":""}},"dates":{"listingContractDate":null,"firstAppearedDate":null,"expirationDate":null,"lastChangeDate":null,"statusChangeDate":null,"insertedDate":null,"yearConverted":0,"age":0,"originalEntryTimestamp":null,"closeDate":null,"cancellationDate":null,"pendingTimestamp":null,"onMarketDate":null,"contingentDate":null,"offMarketDate":null,"cumulativeDaysOnMarket":0,"modificationTimestamp":null},"remarks":{"publicRemarks":"Nice corner lot at Arrow Head Golf Course. This lot is ready to be built on.","privateRemarks":"","miscInfo":"","sellingComments":""},"marketing":{"virtualTourUrlUnbranded":"","internetAutomatedValuationDisplay":true,"internetConsumerComment":true,"internetEntireListingDisplay":false,"internetAddressDisplay":false,"websiteDetailPageUrl":"","isIdxParticipation":false},"closing":null,"homeWarranty":false,"mlsStatus":"","pendingOffer":false,"daysOnMarket":0,"rdmSourceSystemKey":"","isComingSoon":false,"mlsListingId":""},"tax":{"zoning":"","parcelNumber":"","taxTract":"Cherokee Hil","taxAnnualAmount":0,"taxYear":0,"taxOtherAnnualAssessmentAmount":0},"hoa":{"associationFee":0,"associationFeeFrequency":"","associationFee2":0,"associationFee2Frequency":"","associationAmenities":"","associationFeeIncludes":"","petsAllowed":"","associationName":""},"location":{"gis":{"crossStreet":"","mapCoordinate":"","directions":"","latitude":36.8587035,"longitude":-87.8069197,"mlsLatitude":36.8287,"mlsLongitude":-87.87515708,"parcelLatitude":0,"parcelLongitude":0,"geocodedCity":"Cadiz","neighborhoodId":"","neighborhood":""},"address":{"unparsedAddress":"000 Comanche","city":"Cadiz","countyOrParish":"Trigg","stateOrProvince":"KY","postalCode":"42211","streetDirPrefix":"","streetDirSuffix":"","streetName":"","streetNumber":"","unitNumber":"","township":"","country":"","internationalRegion":""},"area":{"mlsAreaMajor":"","subdivisionName":""},"school":{"schoolDistrict":"","elementarySchool":"Trigg County","elementarySchoolDistrict":"","middleOrJuniorSchool":"Trigg County","highSchool":"Trigg County","highSchoolDistrict":"","middleOrJuniorSchoolDistrict":"","sdUnifId":"2105580","sdElemId":"","sdSecId":"1","sazElemId":"KY-TRIGG CO-5702-KY-PB25665","sazMiddleId":"KY-TRIGG CO-5702-KY-PB25663","sazHighId":"KY-TRIGG CO-5702-KY-PB25664"}},"structure":{"architectureStyle":"","heating":"","cooling":"","constructionMaterials":"","flooring":"","levels":"","bedroomsTotal":0,"bathroomsFull":0,"bathroomsPartial":0,"bathroomsOnequarter":0,"bathroomsThreequarter":0,"bathroomsHalf":0,"buildingName":"","buildingFeatures":"","buildingAreaTotal":0,"buildingAreaSource":"","livingArea":0,"roof":"","parkingFeatures":"","parkingTotal":0,"otherParking":"","otherParkingSpaces":"","garageSpaces":0,"carportSpaces":0,"coveredSpaces":0,"openParkingSpaces":0,"yearBuilt":0,"storiesTotal":0,"fireplace":false,"fireplaceFeatures":"","fireplaceTotal":0,"doorFeatures":"","foundationDetails":"","insulationDesc":"","roomType":"","builderName":"","accessibilityFeatures":"","floodArea":"","homeownersProtPlan":"","exteriorFeatures":"","interiorFeatures":"","bodyType":"","basement":"","otherStructures":"","builderModel":"","structureType":"","rooms":{"roomsTotal":0,"kitchenDim":"","livingRmDim":"","masterBrDim":"","diningRmDim":"","familyRmDim":"","diningDesc":"","familyRoomDesc":"","kitchenDesc":"","livingRmDesc":"","bedroomDesc":"","bathroomDesc":""},"propertyCondition":{"isFixerUpper":false,"isNewConstruction":false},"approximateOfficeSquarefeet":0,"approximateRetailSquarefeet":0,"approximateWarehouseSquarefeet":0,"totalRestrooms":0,"load":""},"characteristics":{"lotSizeAcres":"","lotSizeDimensions":"","lotFeatures":"","lotSizeSquareFeet":8712,"poolFeatures":"","privatePool":false,"view":"","laundryFeatures":"","spaFeatures":"","communityFeatures":"","complexName":"","numberOfUnitsInCommunity":0,"waterBodyName":"","waterFrontFeatures":"","waterFront":false,"frontageType":"","numberOfUnitsTotal":0,"hideFromPreloginSearch":false,"seniorCommunity":false,"isSmartHome":false,"currentUse":"","possibleUse":"","numberOfLots":0,"numberOfPads":0,"developmentStatus":"","fencing":"","roadSurfaceType":"","roadResponsibility":"","miscUtilitiesDesc":"","furnished":"","leaseterm":"","isRentersInsuranceRequired":false},"utilities":{"waterSource":"","sewer":"","utilities":"","numberOfSeparateElectricmeters":0,"numberOfSeparateGasmeters":0,"numberOfSeparateWatermeters":0},"equipment":{"otherEquipment":"","appliances":"","securityFeatures":""},"business":{"ownershipType":"","leaseAmountFrequency":""},"photosCount":0},"media":null,"openHouse":null,"dash":null,"masterId":null,"liveStreamOpenHouse":null,"internal":null,"realogy":{"isRealogyListing":true,"isLuxuryListing":false},"isInternalSource":false}]}`)
	listing100095    = string(`{"mlsListings":[{"property":{"propertyType":"SFR","propertySubType":"","financial":null,"listing":{"listingId":"100095","sourceSystemKey":"AR_TMLS","sourceSystemName":"","standardStatus":"SOLD","buildingPermits":"","documentsAvailable":"","disclosures":"","contract":{"currentFinancing":"","specialListingConditions":{"isForeclosure":false,"isShortSale":false,"isProbateSale":false}},"price":{"listPrice":7000,"listPriceHigh":0,"isPriceReduced":false,"priceChangeTimestamp":null,"originalListPrice":0,"closePrice":0,"petRent":0,"monthsRentUpfront":0},"agentOffice":{"listAgent":{"listAgentFullname":"ALYSSA ELLIOTT","listAgentMlsId":"498","listAgentOfficePhone":"","listAgentOfficePhoneType":"","listAgentStateLicense":"","listAgentStateLicenseState":"","listAgentEmail":"","listAgentActive":false,"listAgentAddress":"","listAgentCity":"","listAgentStateOrProvince":"","listAgentPostalCode":"","listAgentType":"","listAgentOriginalEntryTimestamp":null,"listAgentModificationTimestamp":null},"listOffice":{"listOfficeName":"","listOfficePhone":"903-665-6252","listOfficeMlsId":"158","listOfficeAddress":"","listOfficeCity":"","listOfficeStateOrProvince":"","listOfficePostalCode":"","listOfficeEmail":"","listOfficeFax":"","listOfficeOriginalEntryTimestamp":null,"listOfficeModificationTimestamp":null},"coListAgent":null,"coListOffice":null,"buyerAgent":null,"buyerOffice":null,"coBuyerAgent":null,"coBuyerOffice":null},"compensation":{"listAgencyCompensation":null,"buyerAgencyCompensation":{"percentage":0,"fee":0}},"dates":{"listingContractDate":"2020-01-01T00:00:00Z","firstAppearedDate":null,"expirationDate":null,"lastChangeDate":null,"statusChangeDate":null,"insertedDate":null,"yearConverted":0,"age":0,"originalEntryTimestamp":null,"closeDate":"2022-07-01T00:00:00Z","cancellationDate":null,"pendingTimestamp":null,"onMarketDate":null,"contingentDate":null,"offMarketDate":null,"cumulativeDaysOnMarket":0,"modificationTimestamp":null},"remarks":{"publicRemarks":"Reduced!  This 2 bedroom/1 bath fixer upper sits on a 0.14 acre lot in Hooks ISD. This is a great investment opportunity for someone willing to give it TLC.  Schedule an appointment to view today!","privateRemarks":"","miscInfo":"","sellingComments":""},"marketing":{"virtualTourUrlUnbranded":"","internetAutomatedValuationDisplay":true,"internetConsumerComment":true,"internetEntireListingDisplay":false,"internetAddressDisplay":false,"websiteDetailPageUrl":""},"closing":null,"homeWarranty":false},"tax":{"zoning":"","parcelNumber":"","taxTract":"Winnwood (Hooks)","taxAnnualAmount":0,"taxYear":0,"taxOtherAnnualAssessmentAmount":0},"hoa":{"associationFee":0,"associationFeeFrequency":"","associationFee2":0,"associationFee2Frequency":"","associationAmenities":"","associationFeeIncludes":"","petsAllowed":"","associationName":""},"location":{"gis":{"crossStreet":"","mapCoordinate":"","directions":"","latitude":33.4689428,"longitude":-94.2636421,"mlsLatitude":0,"mlsLongitude":0,"parcelLatitude":0,"parcelLongitude":0,"geocodedCity":"Hooks","neighborhoodId":"0"},"address":{"unparsedAddress":"409 Grant","city":"Hooks","countyOrParish":"Bowie","stateOrProvince":"TX","postalCode":"75561","streetDirPrefix":"","streetDirSuffix":"","streetName":"","streetNumber":"","unitNumber":"","township":""},"area":{"mlsAreaMajor":"T15 Hooks","subdivisionName":""},"school":{"schoolDistrict":"","elementarySchool":"","elementarySchoolDistrict":"","middleOrJuniorSchool":"","highSchool":"","highSchoolDistrict":"","middleOrJuniorSchoolDistrict":"","sdUnifId":"4823490","sdElemId":"","sdSecId":"","sazElemId":"TX-HOOKS IS-16087-TX-PB73172","sazMiddleId":"TX-HOOKS IS-16087-TX-PB73172","sazHighId":"TX-HOOKS IS-16087-TX-PB73171"}},"structure":{"architectureStyle":"","heating":"","cooling":"","constructionMaterials":"Frame, Pier/Beam","flooring":"","levels":"1 Story","bedroomsTotal":2,"bathroomsFull":1,"bathroomsPartial":0,"bathroomsOnequarter":0,"bathroomsThreequarter":0,"bathroomsHalf":0,"buildingName":"","buildingFeatures":"","buildingAreaTotal":672,"buildingAreaSource":"","livingArea":0,"roof":"Composition","parkingFeatures":"","parkingTotal":0,"otherParking":"","otherParkingSpaces":"Natural Driveway","garageSpaces":0,"carportSpaces":0,"coveredSpaces":0,"openParkingSpaces":0,"yearBuilt":0,"storiesTotal":0,"fireplace":false,"fireplaceFeatures":"","fireplaceTotal":0,"doorFeatures":"","foundationDetails":"","insulationDesc":"","roomType":"","builderName":"","accessibilityFeatures":"","floodArea":"","homeownersProtPlan":"","exteriorFeatures":"","interiorFeatures":"","bodyType":"","basement":"","otherStructures":"","builderModel":"","structureType":"","rooms":{"roomsTotal":0,"kitchenDim":"","livingRmDim":"","masterBrDim":"","diningRmDim":"","familyRmDim":"","diningDesc":"","familyRoomDesc":"","kitchenDesc":"","livingRmDesc":"","bedroomDesc":"","bathroomDesc":""},"propertyCondition":{"isFixerUpper":true,"isNewConstruction":false},"approximateOfficeSquarefeet":0,"approximateRetailSquarefeet":0,"approximateWarehouseSquarefeet":0,"totalRestrooms":0,"load":""},"characteristics":{"lotSizeAcres":"0.1-0.49","lotSizeDimensions":"","lotFeatures":"","lotSizeSquareFeet":6098,"poolFeatures":"","privatePool":false,"view":"","laundryFeatures":"","spaFeatures":"","communityFeatures":"","complexName":"","numberOfUnitsInCommunity":0,"waterBodyName":"","waterFrontFeatures":"","waterFront":false,"frontageType":"","numberOfUnitsTotal":0,"hideFromPreloginSearch":false,"seniorCommunity":false,"isSmartHome":false,"currentUse":"","possibleUse":"","numberOfLots":0,"numberOfPads":0,"developmentStatus":"","fencing":"","roadSurfaceType":"","roadResponsibility":"","miscUtilitiesDesc":"","furnished":"","leaseterm":"","isRentersInsuranceRequired":false},"utilities":{"waterSource":"","sewer":"","utilities":"","numberOfSeparateElectricmeters":0,"numberOfSeparateGasmeters":0,"numberOfSeparateWatermeters":0},"equipment":{"otherEquipment":"","appliances":"","securityFeatures":""},"business":{"ownershipType":"","leaseAmountFrequency":""},"photosCount":4},"media":{"numImages":4,"modificationTimestamp":"2020-01-27T22:11:44.272Z","lastChangeTimestamp":"2020-01-27T22:11:50.272Z","imageHashCode":"","uuid":"","mediaInfo":[{"indexNum":3,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/AR_TMLS/10/00/95/_P/100095_P02.jpg","photosChangeTimestamp":"2020-01-27T21:03:58.283Z","imageHeight":853,"imageWidth":1280,"md5":"b51023c3d76c0b297e4d5a4c2197ddfe"},{"indexNum":1,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/AR_TMLS/10/00/95/_P/100095_P00.jpg","photosChangeTimestamp":"2020-01-27T21:03:58.365Z","imageHeight":853,"imageWidth":1280,"md5":"53908d18769f597bf4b4a4bdd0946389"},{"indexNum":2,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/AR_TMLS/10/00/95/_P/100095_P01.jpg","photosChangeTimestamp":"2020-01-27T21:03:58.289Z","imageHeight":853,"imageWidth":1280,"md5":"68f8734cecefa9f6cf4573a9245c6084"},{"indexNum":4,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/AR_TMLS/10/00/95/_P/100095_P03.jpg","photosChangeTimestamp":"2020-01-27T21:03:58.289Z","imageHeight":853,"imageWidth":1280,"md5":"da78914820b03fc63772b0b7cfc13ad0"}]},"openHouse":null,"dash":null,"masterId":null}]}`)
	OH_CBR_219027025 = string(`{"mlsListings":[{"property":{"propertyType":"COMMERCIAL_SALE","propertySubType":"","financial":null,"listing":{"listingId":"219027025","sourceSystemKey":"OH_CBR","sourceSystemName":"","standardStatus":"ACTIVE","buildingPermits":"","documentsAvailable":"","disclosures":"","contract":{"currentFinancing":"","specialListingConditions":{"isForeclosure":false,"isShortSale":false,"isProbateSale":false}},"price":{"listPrice":95000,"listPriceHigh":0,"isPriceReduced":false,"priceChangeTimestamp":null,"originalListPrice":0,"closePrice":0,"petRent":0,"monthsRentUpfront":0},"agentOffice":{"listAgent":{"listAgentFullname":"JESSICA L WINLAND","listAgentMlsId":"682550164","listAgentOfficePhone":"","listAgentOfficePhoneType":"","listAgentStateLicense":"","listAgentStateLicenseState":"","listAgentEmail":"","listAgentActive":false,"listAgentAddress":"","listAgentCity":"","listAgentStateOrProvince":"","listAgentPostalCode":"","listAgentType":"","listAgentOriginalEntryTimestamp":null,"listAgentModificationTimestamp":null},"listOffice":{"listOfficeName":"COLDWELL BANKER KING THOMPSON","listOfficePhone":"740-366-3318","listOfficeMlsId":"02950","listOfficeAddress":"","listOfficeCity":"","listOfficeStateOrProvince":"","listOfficePostalCode":"","listOfficeEmail":"","listOfficeFax":"","listOfficeOriginalEntryTimestamp":null,"listOfficeModificationTimestamp":null},"coListAgent":null,"coListOffice":null,"buyerAgent":{"buyerAgentFullname":"","buyerAgentMlsId":"","buyerOfficePhone":""},"buyerOffice":{"buyerOfficeName":"","buyerOfficeMlsId":"","buyerOfficePhone":""},"coBuyerAgent":null,"coBuyerOffice":null},"compensation":{"listAgencyCompensation":null,"buyerAgencyCompensation":{"percentage":0,"fee":0}},"dates":{"listingContractDate":"2019-07-18T00:00:00Z","firstAppearedDate":null,"expirationDate":null,"lastChangeDate":null,"statusChangeDate":null,"insertedDate":null,"yearConverted":0,"age":0,"originalEntryTimestamp":null,"closeDate":null,"cancellationDate":null,"pendingTimestamp":null,"onMarketDate":null,"contingentDate":null,"offMarketDate":null,"cumulativeDaysOnMarket":0,"modificationTimestamp":null},"remarks":{"publicRemarks":"Have you ever thought about owning your own restaurant? This est. restaurant has ev. you need to get started quickly! All appliances are commercial grade, mostly consisting of stainless steel! The kitchen area is equipped with a steam table, a 64in. seasoned grill, a microwave, toasters, 2 cooking burners, 3-bay sink with soap \u0026 sanitizing dispensers and a commercial grade refrigerator. The 2-basket fryer, and 16-compartment prep table were both new in 2018. All dishes, coffee makers, pitchers, pots, pans, utensils and many more misc. items convey with the sale. The upright freezer and the chest freezer in the back hallway, by the storage room, work great! The booths and table tops were replaced in 2018 and provide ample seating in addition to the 6 bar stools at the counter area. SEE A2A.","privateRemarks":"","miscInfo":"","sellingComments":""},"marketing":{"virtualTourUrlUnbranded":"http://tour.circlepix.com/home2/MGV448/9-W-2nd-Street-Frazeysburg-OH-219027025","internetAutomatedValuationDisplay":false,"internetConsumerComment":false,"internetEntireListingDisplay":false,"internetAddressDisplay":false,"websiteDetailPageUrl":""},"closing":null,"homeWarranty":false},"tax":{"zoning":"","parcelNumber":"29-61-17-01-000","taxTract":"","taxAnnualAmount":1901,"taxYear":0,"taxOtherAnnualAssessmentAmount":0},"hoa":{"associationFee":0,"associationFeeFrequency":"","associationFee2":0,"associationFee2Frequency":"","associationAmenities":"","associationFeeIncludes":"","petsAllowed":"","associationName":""},"location":{"gis":{"crossStreet":"","mapCoordinate":"","directions":"","latitude":0,"longitude":0,"mlsLatitude":40.117384,"mlsLongitude":82.117393,"parcelLatitude":0,"parcelLongitude":0,"geocodedCity":"","neighborhoodId":""},"address":{"unparsedAddress":"9 W 2nd Street","city":"Frazeysburg","countyOrParish":"Muskingum","stateOrProvince":"OH","postalCode":"43822","streetDirPrefix":"","streetDirSuffix":"","streetName":"","streetNumber":"","unitNumber":"","township":""},"area":{"mlsAreaMajor":"","subdivisionName":""},"school":{"schoolDistrict":"","elementarySchool":"","elementarySchoolDistrict":"","middleOrJuniorSchool":"","highSchool":"","highSchoolDistrict":"","middleOrJuniorSchoolDistrict":"","sdUnifId":"","sdElemId":"","sdSecId":"","sazElemId":"","sazMiddleId":"","sazHighId":""}},"structure":{"architectureStyle":"","heating":"","cooling":"","constructionMaterials":"","flooring":"","levels":"","bedroomsTotal":0,"bathroomsFull":0,"bathroomsPartial":0,"bathroomsOnequarter":0,"bathroomsThreequarter":0,"bathroomsHalf":0,"buildingName":"","buildingFeatures":"","buildingAreaTotal":1020,"buildingAreaSource":"","livingArea":0,"roof":"","parkingFeatures":"","parkingTotal":0,"otherParking":"","otherParkingSpaces":"","garageSpaces":1,"carportSpaces":0,"coveredSpaces":0,"openParkingSpaces":0,"yearBuilt":1920,"storiesTotal":0,"fireplace":false,"fireplaceFeatures":"","fireplaceTotal":0,"doorFeatures":"","foundationDetails":"","insulationDesc":"","roomType":"","builderName":"","accessibilityFeatures":"","floodArea":"","homeownersProtPlan":"","exteriorFeatures":"","interiorFeatures":"","bodyType":"","basement":"","otherStructures":"","builderModel":"","structureType":"","rooms":{"roomsTotal":0,"kitchenDim":"","livingRmDim":"","masterBrDim":"","diningRmDim":"","familyRmDim":"","diningDesc":"","familyRoomDesc":"","kitchenDesc":"","livingRmDesc":"","bedroomDesc":"","bathroomDesc":""},"propertyCondition":{"isFixerUpper":false,"isNewConstruction":false},"approximateOfficeSquarefeet":0,"approximateRetailSquarefeet":0,"approximateWarehouseSquarefeet":0,"totalRestrooms":0,"load":""},"characteristics":{"lotSizeAcres":"","lotSizeDimensions":"","lotFeatures":"","lotSizeSquareFeet":1306,"poolFeatures":"","privatePool":false,"view":"","laundryFeatures":"","spaFeatures":"","communityFeatures":"","complexName":"","numberOfUnitsInCommunity":0,"waterBodyName":"","waterFrontFeatures":"","waterFront":false,"frontageType":"","numberOfUnitsTotal":0,"hideFromPreloginSearch":false,"seniorCommunity":false,"isSmartHome":false,"currentUse":"","possibleUse":"","numberOfLots":0,"numberOfPads":0,"developmentStatus":"","fencing":"","roadSurfaceType":"","roadResponsibility":"","miscUtilitiesDesc":"","furnished":"","leaseterm":"","isRentersInsuranceRequired":false},"utilities":{"waterSource":"","sewer":"","utilities":"","numberOfSeparateElectricmeters":0,"numberOfSeparateGasmeters":0,"numberOfSeparateWatermeters":0},"equipment":{"otherEquipment":"","appliances":"","securityFeatures":""},"business":{"ownershipType":"","leaseAmountFrequency":""},"photosCount":31},"media":{"numImages":31,"modificationTimestamp":"2020-01-15T22:50:42.451Z","imageHashCode":"","uuid":"","lastChangeTimestamp":null,"mediaInfo":[{"indexNum":31,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P30.jpg","photosChangeTimestamp":"2020-01-15T09:34:40.214Z","imageHeight":200,"imageWidth":300,"md5":"f52a56ad6c791aae7c9254fc24c5f62f"},{"indexNum":1,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P00.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.234Z","imageHeight":192,"imageWidth":143,"md5":"4db27a0fdb7857e19dce84a26a9213b7"},{"indexNum":6,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P05.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.322Z","imageHeight":200,"imageWidth":300,"md5":"431bbcf414f4bdaea18c016ede8aeb65"},{"indexNum":27,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P26.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.226Z","imageHeight":192,"imageWidth":128,"md5":"47b637e0e23d639feeb7e534de7c9c78"},{"indexNum":24,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P23.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.231Z","imageHeight":200,"imageWidth":300,"md5":"93df425a60631869f46a9ab753ec7b5a"},{"indexNum":9,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P08.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.234Z","imageHeight":200,"imageWidth":300,"md5":"c55e578d7dd1a3a188bf1e58928ddf94"},{"indexNum":18,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P17.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.022Z","imageHeight":200,"imageWidth":300,"md5":"4d324bafdbb2887d78b10d05e5a79b30"},{"indexNum":15,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P14.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.804Z","imageHeight":200,"imageWidth":300,"md5":"3cd63d93fe2993cf2080735013c34cb6"},{"indexNum":28,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P27.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.225Z","imageHeight":192,"imageWidth":132,"md5":"c0177bdf26e8969cd4e8dafb35b4f9ea"},{"indexNum":17,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P16.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.310Z","imageHeight":199,"imageWidth":300,"md5":"6a03af5fb8e67f15afa6ed595c2e2bc9"},{"indexNum":23,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P22.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.213Z","imageHeight":200,"imageWidth":300,"md5":"bd31982714ea3e221d2a7226c2f77234"},{"indexNum":4,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P03.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.226Z","imageHeight":208,"imageWidth":300,"md5":"dfa164c2fa4797874dbbb7c126263622"},{"indexNum":5,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P04.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.226Z","imageHeight":192,"imageWidth":128,"md5":"5cfc11c3ba955157440813cb2d1ac888"},{"indexNum":12,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P11.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.310Z","imageHeight":199,"imageWidth":300,"md5":"e3f35a1d6257533ab4bb23f8cab8c75d"},{"indexNum":20,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P19.jpg","photosChangeTimestamp":"2020-01-15T09:34:45.113Z","imageHeight":200,"imageWidth":300,"md5":"b630ab2db4b824a7822fb320c006ea80"},{"indexNum":8,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P07.jpg","photosChangeTimestamp":"2020-01-15T09:34:45.214Z","imageHeight":200,"imageWidth":300,"md5":"6ccbc29ba6c7ce0604d4d75ff2fa3aa1"},{"indexNum":7,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P06.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.228Z","imageHeight":167,"imageWidth":300,"md5":"6f3de47bb052886630839e5e0a4e6c95"},{"indexNum":10,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P09.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.011Z","imageHeight":200,"imageWidth":300,"md5":"520753b8701bb762bba1b3ba7942732d"},{"indexNum":16,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P15.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.222Z","imageHeight":200,"imageWidth":300,"md5":"e81aab9bbe412c6e670cb62fbf53d180"},{"indexNum":19,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P18.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.119Z","imageHeight":199,"imageWidth":300,"md5":"e99ae4104c94e894221cb52fe9434380"},{"indexNum":2,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P01.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.213Z","imageHeight":192,"imageWidth":135,"md5":"e4066f5d913b35d822a50ba466b59fb4"},{"indexNum":22,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P21.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.229Z","imageHeight":200,"imageWidth":300,"md5":"1b2ef05f5a352f966a7dd949b93db96a"},{"indexNum":11,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P10.jpg","photosChangeTimestamp":"2020-01-15T09:34:45.023Z","imageHeight":192,"imageWidth":300,"md5":"e1bd980c184c0e8013a8d45d5c74e6cd"},{"indexNum":14,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P13.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.228Z","imageHeight":200,"imageWidth":300,"md5":"f9bd556075b36f48f17bf05f179bbc47"},{"indexNum":3,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P02.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.009Z","imageHeight":261,"imageWidth":300,"md5":"a20e3fba036bf12c0db648aa0f3ef396"},{"indexNum":13,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P12.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.219Z","imageHeight":200,"imageWidth":300,"md5":"5cb741fdcf57a767b8182c2f7bf08cdd"},{"indexNum":26,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P25.jpg","photosChangeTimestamp":"2020-01-15T09:34:45.515Z","imageHeight":200,"imageWidth":300,"md5":"3e059708e48c0401de6b4b29c4213fee"},{"indexNum":30,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P29.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.213Z","imageHeight":192,"imageWidth":128,"md5":"a5ea59e3167cbf23daab4d169be3896f"},{"indexNum":29,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P28.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.310Z","imageHeight":192,"imageWidth":128,"md5":"89d0fd6d972bda6b17df7049004c6e8b"},{"indexNum":21,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P20.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.232Z","imageHeight":200,"imageWidth":300,"md5":"7e14878cc0e7d8ab1367d1cce7c324e8"},{"indexNum":25,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/19/02/70/25/_P/219027025_P24.jpg","photosChangeTimestamp":"2020-01-15T09:34:44.009Z","imageHeight":192,"imageWidth":135,"md5":"4d420eb1ae6254be44c09d9be9a54bbc"}]},"openHouse":null,"dash":{"listingGuid":"","sourceSystemKey":"","listingAgentGuid":"feeedc48-79b6-49ac-801a-88927e22220b","companyStaffGuid":"152ced2d-ef39-4587-b201-668e8d8b9114"},"masterId":{"listingMasterId":"","propertyMasterId":"","listAgentMasterId":"Q00200000FDEuUMkQYUEOKYzUDCFObN1wo69zJlf","listOfficeMasterId":"Q00400000FDEnNtsTZmTFE8Sa3TqGxBl5uicDmle","coListAgentMasterId":"","coListOfficeMasterId":"","buyerAgentMasterId":"","buyerOfficeMasterId":"","coBuyerAgentMasterId":"","coBuyerOfficeMasterId":"","addressMasterId":"","companyMasterId":""}}]}`)
	OH_CBR_213002352 = string(`{"mlsListings":[{"isInternalSource" : true, "property":{"propertyType":"LAND","propertySubType":"","financial":null,"listing":{"listingId":"213002352","mlsListingId":"Q-213002352","sourceSystemKey":"OH_CBR","sourceSystemName":"","standardStatus":"ACTIVE","buildingPermits":"","documentsAvailable":"","disclosures":"","contract":{"currentFinancing":"","specialListingConditions":{"isForeclosure":false,"isShortSale":false,"isProbateSale":false}},"price":{"listPrice":123900,"listPriceHigh":0,"isPriceReduced":false,"priceChangeTimestamp":null,"originalListPrice":0,"closePrice":0,"petRent":0,"monthsRentUpfront":0},"agentOffice":{"listAgent":{"listAgentFullname":"LINDA K CHAMBERS","listAgentMlsId":"658010880","listAgentOfficePhone":"","listAgentOfficePhoneType":"","listAgentStateLicense":"","listAgentStateLicenseState":"","listAgentEmail":"","listAgentActive":false,"listAgentAddress":"","listAgentCity":"","listAgentStateOrProvince":"","listAgentPostalCode":"","listAgentType":"","listAgentOriginalEntryTimestamp":null,"listAgentModificationTimestamp":null},"listOffice":{"listOfficeName":"KEY PROPERTIES, REALTORS","listOfficePhone":"740-967-1060","listOfficeMlsId":"06730","listOfficeAddress":"","listOfficeCity":"","listOfficeStateOrProvince":"","listOfficePostalCode":"","listOfficeEmail":"","listOfficeFax":"","listOfficeOriginalEntryTimestamp":null,"listOfficeModificationTimestamp":null},"coListAgent":null,"coListOffice":null,"buyerAgent":{"buyerAgentFullname":"","buyerAgentMlsId":"","buyerOfficePhone":""},"buyerOffice":{"buyerOfficeName":"","buyerOfficeMlsId":"","buyerOfficePhone":""},"coBuyerAgent":null,"coBuyerOffice":null,"idxContactInfo":"beth@realty.com"},"compensation":{"listAgencyCompensation":null,"buyerAgencyCompensation":{"percentage":0,"fee":0,"commission":""}},"dates":{"listingContractDate":"2013-01-24T00:00:00Z","firstAppearedDate":"2014-01-05T23:38:46Z","expirationDate":null,"lastChangeDate":"2021-09-09T13:52:26.847Z","statusChangeDate":null,"insertedDate":null,"yearConverted":0,"age":0,"originalEntryTimestamp":"2013-01-25T11:36:00Z","closeDate":null,"cancellationDate":null,"pendingTimestamp":null,"onMarketDate":null,"contingentDate":null,"offMarketDate":null,"cumulativeDaysOnMarket":0,"modificationTimestamp":null},"remarks":{"publicRemarks":"LOT 27 OF BEAUTIFUL RACCOON CREEK ESTATES. EXECUTIVE BUILDING SITES WITH UNIQUE TERRAIN. LOTS RANGE FROM .5 TO 3.5 ACRES. SOME WOODED. ALL PUBLIC UTILITIES AVAILABLE.","privateRemarks":"","miscInfo":"","sellingComments":""},"marketing":{"virtualTourUrlUnbranded":"","internetAutomatedValuationDisplay":false,"internetConsumerComment":false,"internetEntireListingDisplay":true,"internetAddressDisplay":false,"websiteDetailPageUrl":"","isIdxParticipation":true},"closing":null,"homeWarranty":false,"mlsStatus":"Contingent","pendingOffer":true,"daysOnMarket":0,"rdmSourceSystemKey":"OH_CBR","isComingSoon":false},"tax":{"zoning":"","parcelNumber":"05317347200027","taxTract":"RACCOON CREEK ESTATES","taxAnnualAmount":11,"taxYear":0,"taxOtherAnnualAssessmentAmount":0},"hoa":{"associationFee":0,"associationFeeFrequency":"","associationFee2":0,"associationFee2Frequency":"","associationAmenities":"","associationFeeIncludes":"","petsAllowed":"","associationName":""},"location":{"gis":{"crossStreet":"","mapCoordinate":"","directions":"","latitude":40.153308,"longitude":-82.693656,"mlsLatitude":40.153289794921875,"mlsLongitude":-82.69365692138672,"parcelLatitude":0,"parcelLongitude":0,"geocodedCity":"Johnstown","neighborhoodId":"0"},"address":{"unparsedAddress":"102 Benedict Drive","city":"Johnstown","countyOrParish":"Licking","stateOrProvince":"OH","postalCode":"43031","streetDirPrefix":"","streetDirSuffix":"","streetName":"","streetNumber":"","unitNumber":"","township":"Monroe","country":"US","internationalRegion":""},"area":{"mlsAreaMajor":"","subdivisionName":""},"school":{"schoolDistrict":"","elementarySchool":"","elementarySchoolDistrict":"","middleOrJuniorSchool":"","highSchool":"","highSchoolDistrict":"","middleOrJuniorSchoolDistrict":"","sdUnifId":"3904798","sdElemId":"","sdSecId":"","sazElemId":"OH-JOHNSTOW-12961-OH-PB58122","sazMiddleId":"OH-JOHNSTOW-12961-OH-PB58122","sazHighId":"OH-JOHNSTOW-12961-OH-PB58120"}},"structure":{"architectureStyle":"","heating":"","cooling":"","constructionMaterials":"","flooring":"","levels":"","bedroomsTotal":0,"bathroomsFull":0,"bathroomsPartial":0,"bathroomsOnequarter":0,"bathroomsThreequarter":0,"bathroomsHalf":0,"buildingName":"","buildingFeatures":"","buildingAreaTotal":0,"buildingAreaSource":"","livingArea":0,"roof":"","parkingFeatures":"","parkingTotal":0,"otherParking":"","otherParkingSpaces":"","garageSpaces":0,"carportSpaces":0,"coveredSpaces":0,"openParkingSpaces":0,"yearBuilt":0,"storiesTotal":0,"fireplace":false,"fireplaceFeatures":"","fireplaceTotal":0,"doorFeatures":"","foundationDetails":"","insulationDesc":"","roomType":"","builderName":"","accessibilityFeatures":"","floodArea":"","homeownersProtPlan":"","exteriorFeatures":"","interiorFeatures":"","bodyType":"Residential Land","basement":"","otherStructures":"","builderModel":"","structureType":"","rooms":{"roomsTotal":0,"kitchenDim":"","livingRmDim":"","masterBrDim":"","diningRmDim":"","familyRmDim":"","diningDesc":"","familyRoomDesc":"","kitchenDesc":"","livingRmDesc":"","bedroomDesc":"","bathroomDesc":""},"propertyCondition":{"isFixerUpper":false,"isNewConstruction":false},"approximateOfficeSquarefeet":0,"approximateRetailSquarefeet":0,"approximateWarehouseSquarefeet":0,"totalRestrooms":0,"load":""},"characteristics":{"lotSizeAcres":"","lotSizeDimensions":"","lotFeatures":"","lotSizeSquareFeet":113256,"poolFeatures":"","privatePool":false,"view":"","laundryFeatures":"","spaFeatures":"","communityFeatures":"","complexName":"","numberOfUnitsInCommunity":0,"waterBodyName":"","waterFrontFeatures":"","waterFront":false,"frontageType":"","numberOfUnitsTotal":0,"hideFromPreloginSearch":false,"seniorCommunity":false,"isSmartHome":false,"currentUse":"","possibleUse":"","numberOfLots":0,"numberOfPads":0,"developmentStatus":"","fencing":"","roadSurfaceType":"","roadResponsibility":"","miscUtilitiesDesc":"","furnished":"","leaseterm":"","isRentersInsuranceRequired":false},"utilities":{"waterSource":"","sewer":"","utilities":"","numberOfSeparateElectricmeters":0,"numberOfSeparateGasmeters":0,"numberOfSeparateWatermeters":0},"equipment":{"otherEquipment":"","appliances":"","securityFeatures":""},"business":{"ownershipType":"","leaseAmountFrequency":""},"photosCount":1},"media":{"numImages":1,"modificationTimestamp":"2020-07-08T23:30:14.594Z","imageHashCode":"","uuid":"","lastChangeTimestamp":null,"mediaInfo":[{"indexNum":0,"mediaUrl":"https://qaimages-mls.static-ziprealty.com/OH_CBR/2/13/00/23/52/_P/213002352_P00.jpg","photosChangeTimestamp":"2020-07-08T23:30:14.594Z","imageHeight":480,"imageWidth":640,"md5":"859562cd5f1f4da61791d04f976a5177"}]},"openHouse":null,"dash":{"listingGuid":"","sourceSystemKey":"","listingAgentGuid":"","companyStaffGuid":""},"masterId":{"listingMasterId":"","propertyMasterId":"","listAgentMasterId":"","listOfficeMasterId":"","coListAgentMasterId":"","coListOfficeMasterId":"","buyerAgentMasterId":"","buyerOfficeMasterId":"","coBuyerAgentMasterId":"","coBuyerOfficeMasterId":"","addressMasterId":"Q01000000FAiE22jQ6ATDqh5lfz3BDLsdrBp15RK","companyMasterId":""},"liveStreamOpenHouse":null,"internal":{"city":"Johnstown"},"realogy":{"isRealogyListing":true,"isLuxuryListing":true}}]}`)
)

func TestIntegrationGatewayMlsListingsByListingId(t *testing.T) {
	endpointUrl := fmt.Sprintf("http://localhost:%d/mls/listing/100018", port)
	resp, err := http.Get(endpointUrl)
	defer resp.Body.Close()

	assert.Nil(t, err)
	assert.NotNil(t, resp)
	assert.Equal(t, "application/json", resp.Header.Get("Content-Type"))

	buf, err := ioutil.ReadAll(resp.Body)
	assert.Nil(t, err)
	assert.Equal(t, http.StatusOK, resp.StatusCode)

	var msg pb.GetMlsListingByListingIdResponse
	if err := jsonpb.UnmarshalString(string(buf), &msg); err != nil {
		t.Errorf("unable to unmarshall due to %v", err)
		return
	}

	assert.Equal(t, len(msg.MlsListings), 1)
	assert.Equal(t, "100018", msg.MlsListings[0].Property.Listing.ListingId)

	// verify response json
	testListingJson := listing100018
	testListings := &pb.GetMlsListingByListingIdResponse{}
	jsonpb.Unmarshal(strings.NewReader(testListingJson), testListings)
	AssertElementsMatch(t, msg.MlsListings, testListings.MlsListings)
}

func TestIntegrationGatewayRealogyListings(t *testing.T) {
	endpointUrl := fmt.Sprintf("http://localhost:%d/mls/listings/realogy?sourceSystemKey=OH_CBR&standardStatus=ACTIVE", port)
	resp, err := http.Get(endpointUrl)
	defer resp.Body.Close()

	assert.Nil(t, err)
	assert.NotNil(t, resp)
	assert.Equal(t, "application/json", resp.Header.Get("Content-Type"))

	buf, err := ioutil.ReadAll(resp.Body)
	assert.Nil(t, err)
	assert.Equal(t, http.StatusOK, resp.StatusCode)

	var msg pb.RealogyListingsResponse
	if err := jsonpb.UnmarshalString(string(buf), &msg); err != nil {
		t.Errorf("unable to unmarshall due to %v", err)
		return
	}

	assert.Equal(t, len(msg.MlsListings), 1)
	assert.Equal(t, "213002352", msg.MlsListings[0].Property.Listing.ListingId)

	// verify response json
	testListingJson := OH_CBR_213002352
	testListings := &pb.RealogyListingsResponse{}
	jsonpb.Unmarshal(strings.NewReader(testListingJson), testListings)
	AssertElementsMatch(t, msg.MlsListings, testListings.MlsListings)
}

type errorBody struct {
	Message string        `json:"message"`
	Code    int           `json:"code"`
	Details []interface{} `json:"details"`
}

func TestIntegrationGatewayMlsListingsByListingIdNotFound(t *testing.T) {
	endpointUrl := fmt.Sprintf("http://localhost:%d/mls/listing/99887766", port) // this listing id does not exist.
	resp, err := http.Get(endpointUrl)
	defer resp.Body.Close()

	assert.Nil(t, err)
	assert.NotNil(t, resp)
	assert.Equal(t, "application/json", resp.Header.Get("Content-Type"))

	buf, err := ioutil.ReadAll(resp.Body)
	assert.Nil(t, err)
	assert.Equal(t, http.StatusNotFound, resp.StatusCode)

	var msg errorBody
	if err := json.Unmarshal(buf, &msg); err != nil {
		t.Errorf("json.Unmarshal(%s, &msg) failed with %v; want success", buf, err)
		return
	}

	assert.Equal(t, fmt.Sprintf("Unable to find mls listings for %s", "listing_id:\"99887766\""), msg.Message) // notice the extra space character at the end of the error message.
}

func TestIntegrationGatewayMlsListingsBySource(t *testing.T) {
	endpointUrl := fmt.Sprintf("http://localhost:%d/mls/source/AR_TMLS", port)
	resp, err := http.Get(endpointUrl)
	defer resp.Body.Close()

	assert.Nil(t, err)
	assert.NotNil(t, resp)
	assert.Equal(t, "application/json", resp.Header.Get("Content-Type"))

	buf, err := ioutil.ReadAll(resp.Body)
	assert.Nil(t, err)
	assert.Equal(t, http.StatusOK, resp.StatusCode)

	var msg pb.GetMlsListingsBySourceResponse
	if err := jsonpb.UnmarshalString(string(buf), &msg); err != nil {
		t.Errorf("unable to unmarshall due to %v", err)
		return
	}

	assert.Equal(t, len(msg.MlsListings), 1)
	assert.Equal(t, "100095", msg.MlsListings[0].Property.Listing.ListingId)

	// verify response json
	testListingJson := listing100095
	testListings := &pb.GetMlsListingsBySourceResponse{}
	jsonpb.Unmarshal(strings.NewReader(testListingJson), testListings)
	AssertElementsMatch(t, msg.MlsListings, testListings.MlsListings)
}

func TestIntegrationGatewayGetMlsListingsByCompanyStaffGuid(t *testing.T) {
	endpointUrl := fmt.Sprintf("http://localhost:%d/mls/dash/staff/152ced2d-ef39-4587-b201-668e8d8b9114", port)
	resp, err := http.Get(endpointUrl)
	defer resp.Body.Close()

	assert.Nil(t, err)
	assert.NotNil(t, resp)
	assert.Equal(t, "application/json", resp.Header.Get("Content-Type"))

	buf, err := ioutil.ReadAll(resp.Body)
	assert.Nil(t, err)
	assert.Equal(t, http.StatusOK, resp.StatusCode)

	var msg pb.GetMlsListingsByCompanyStaffGuidResponse
	if err := jsonpb.UnmarshalString(string(buf), &msg); err != nil {
		t.Errorf("unable to unmarshall due to %v", err)
		return
	}

	assert.Equal(t, len(msg.MlsListings), 1)
	assert.Equal(t, "152ced2d-ef39-4587-b201-668e8d8b9114", msg.MlsListings[0].Dash.CompanyStaffGuid)

	// verify response json
	testListingJson := OH_CBR_219027025
	testListings := &pb.GetMlsListingsByCompanyStaffGuidResponse{}
	jsonpb.Unmarshal(strings.NewReader(testListingJson), testListings)
	AssertElementsMatch(t, msg.MlsListings, testListings.MlsListings)
}

// json comparison
func AssertElementsMatch(t *testing.T, protoResponse []*pb.MlsListing, testListings []*pb.MlsListing) {
	actualJson, _ := json.Marshal(protoResponse)
	expectedJson, _ := json.Marshal(testListings)
	opts := jsondiff.DefaultConsoleOptions()
	opts.PrintTypes = false
	difference, _ := jsondiff.Compare(expectedJson, actualJson, &opts)
	assert.Equal(t, jsondiff.FullMatch, difference)
}
